# GitHub Actions Cloud Automation (Free Alternative)

name: IPO Alert - Cloud Automation
on:
  schedule:
    # Run at 6:30 AM UTC (12:00 PM IST) - Daily at noon
    - cron: '30 6 * * *'   # 12 PM IST (noon)
  workflow_dispatch: # Allow manual runs

jobs:
  ipo-alert:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow pushing changes back to repo
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Create data directory
      run: mkdir -p data

    - name: Run IPO Alert
      env:
        EMAIL_ADDRESS: ${{ secrets.EMAIL_ADDRESS }}
        APP_PASSWORD: ${{ secrets.APP_PASSWORD }}
        RECIPIENT_EMAIL_LIST: ${{ secrets.RECIPIENT_EMAIL_LIST }}
        RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        RESEND_FROM_EMAIL: ${{ secrets.RESEND_FROM_EMAIL }}
      run: |
        python -c "
        import sys
        sys.path.insert(0, 'src')
        from src.main_app import IPOAlert

        try:
            app = IPOAlert()
            success = app.run()
            print('✅ IPO Alert completed successfully' if success else '❌ IPO Alert failed')
        except Exception as e:
            print(f'❌ Error: {e}')
            sys.exit(1)
        "

    - name: Commit notification history
      if: success()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/ipo_history.json
        git diff --staged --quiet || git commit -m "Update IPO notification history [skip ci]"
        git push

    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ipo-alert-logs
        path: logs/